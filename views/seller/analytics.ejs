<%- include('../partials/breadcrumbs', { breadcrumbs: breadcrumbs }) %>

<h1><i class="fas fa-chart-line me-2"></i>Analitik Penjualan Saya</h1>
<p>Pantau performa penjualan source code Anda.</p>
<hr>

<div class="row mb-3 align-items-end">
    <div class="col-md-4">
        <label for="periodFilter" class="form-label">Pilih Periode:</label>
        <select id="periodFilter" class="form-select">
            <option value="last7days">7 Hari Terakhir</option>
            <option value="last30days" selected>30 Hari Terakhir</option>
            <option value="alltime">Semua Waktu</option>
        </select>
    </div>
    <div class="col-md-4">
        <label for="scFilter" class="form-label">Filter per Source Code (Opsional):</label>
        <select id="scFilter" class="form-select">
            <option value="">Semua Source Code</option>
            <% if (typeof sellerSourceCodes !== 'undefined' && sellerSourceCodes.length > 0) { %>
                <% sellerSourceCodes.forEach(sc => { %>
                    <option value="<%= sc._id %>"><%= sc.title %></option>
                <% }); %>
            <% } %>
        </select>
    </div>
     <div class="col-md-2">
        <button id="applyFilterBtn" class="btn btn-primary w-100"><i class="fas fa-filter me-1"></i> Terapkan</button>
    </div>
</div>

<div id="analyticsLoading" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-light">Memuat data analitik...</p>
</div>

<div id="analyticsContent" style="display: none;">
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center bg-dark-tertiary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pendapatan</h5>
                    <p class="display-5 fw-bold text-success" id="totalSalesAmount">Rp 0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-dark-tertiary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Total Pesanan</h5>
                    <p class="display-5 fw-bold text-info" id="totalOrders">0</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center bg-dark-tertiary shadow-sm">
                <div class="card-body">
                    <h5 class="card-title text-muted">Pembeli Unik</h5>
                    <p class="display-5 fw-bold text-warning" id="totalUniqueBuyers">0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-7 mb-4">
            <div class="card bg-dark-tertiary shadow-sm">
                <div class="card-header">Pendapatan Harian (<span id="chartPeriod"></span>)</div>
                <div class="card-body">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5 mb-4">
            <div class="card bg-dark-tertiary shadow-sm">
                <div class="card-header">Top 5 Source Code Terlaris (<span id="topScPeriod"></span>)</div>
                <div class="card-body">
                    <ul class="list-group list-group-flush" id="topSellingScList">
                        <li class="list-group-item bg-dark-tertiary text-muted">Memuat data...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="analyticsError" class="alert alert-danger" style="display: none;"></div>


<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const periodFilter = document.getElementById('periodFilter');
    const scFilter = document.getElementById('scFilter');
    const applyFilterBtn = document.getElementById('applyFilterBtn');

    const totalSalesAmountEl = document.getElementById('totalSalesAmount');
    const totalOrdersEl = document.getElementById('totalOrders');
    const totalUniqueBuyersEl = document.getElementById('totalUniqueBuyers');
    const topSellingScListEl = document.getElementById('topSellingScList');
    const dailySalesChartCanvas = document.getElementById('dailySalesChart');
    const chartPeriodEl = document.getElementById('chartPeriod');
    const topScPeriodEl = document.getElementById('topScPeriod');
    const analyticsLoadingEl = document.getElementById('analyticsLoading');
    const analyticsContentEl = document.getElementById('analyticsContent');
    const analyticsErrorEl = document.getElementById('analyticsError');

    let dailySalesChartInstance;

    async function fetchAnalyticsData() {
        const period = periodFilter.value;
        const selectedScId = scFilter.value;
        
        analyticsLoadingEl.style.display = 'block';
        analyticsContentEl.style.display = 'none';
        analyticsErrorEl.style.display = 'none';

        try {
            let apiUrl = `/api/seller/analytics-data?period=${period}`;
            if (selectedScId) {
                apiUrl += `&scId=${selectedScId}`;
            }
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errData = await response.json().catch(() => ({ message: 'Gagal mengambil data analitik.'}));
                throw new Error(errData.message || `HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            totalSalesAmountEl.textContent = `Rp ${data.summary.totalSalesAmount.toLocaleString('id-ID')}`;
            totalOrdersEl.textContent = data.summary.totalOrders;
            totalUniqueBuyersEl.textContent = data.summary.totalUniqueBuyers;
            
            const periodText = periodFilter.options[periodFilter.selectedIndex].text;
            chartPeriodEl.textContent = periodText;
            topScPeriodEl.textContent = periodText;

            topSellingScListEl.innerHTML = '';
            if (data.topSellingSc.length > 0) {
                data.topSellingSc.forEach(sc => {
                    const li = document.createElement('li');
                    li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center', 'bg-dark-tertiary', 'text-light');
                    li.innerHTML = `
                        <a href="/sc/${sc._id}" target="_blank" class="text-light text-decoration-none">${sc.title}</a>
                        <span class="badge bg-primary rounded-pill">${sc.totalSold} terjual</span>
                    `;
                    topSellingScListEl.appendChild(li);
                });
            } else {
                topSellingScListEl.innerHTML = '<li class="list-group-item bg-dark-tertiary text-muted">Tidak ada data penjualan.</li>';
            }

            const chartLabels = data.dailySales.map(d => new Date(d._id).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }));
            const chartRevenueData = data.dailySales.map(d => d.dailyRevenue);

            if (dailySalesChartInstance) {
                dailySalesChartInstance.destroy();
            }
            dailySalesChartInstance = new Chart(dailySalesChartCanvas, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'Pendapatan (Rp)',
                        data: chartRevenueData,
                        borderColor: 'rgba(0, 207, 232, 1)',
                        backgroundColor: 'rgba(0, 207, 232, 0.1)',
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'rgba(0, 207, 232, 1)',
                        pointBorderColor: '#fff',
                        pointHoverRadius: 7,
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(0, 207, 232, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: '#B0B0B0',
                                callback: function(value) { return 'Rp ' + value.toLocaleString('id-ID'); }
                            },
                            grid: { color: 'rgba(176,176,176,0.1)'}
                        },
                        x: {
                            ticks: { color: '#B0B0B0' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        label += 'Rp ' + context.parsed.y.toLocaleString('id-ID');
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            analyticsContentEl.style.display = 'block';
        } catch (error) {
            analyticsErrorEl.textContent = `Error: ${error.message}`;
            analyticsErrorEl.style.display = 'block';
            console.error("Error fetching or processing analytics data:", error);
        } finally {
            analyticsLoadingEl.style.display = 'none';
        }
    }

    applyFilterBtn.addEventListener('click', fetchAnalyticsData);
    fetchAnalyticsData(); // Load data on initial page load
});
</script>